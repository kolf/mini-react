# React 18 æºç æ¶æ„æ¢³ç†

## ğŸ“‹ é¡¹ç›®æ¦‚è§ˆ

æˆ‘ä»¬æ­£åœ¨æ‰‹å†™å®ç°React 18çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œç›®å‰å·²ç»å®Œæˆäº†åŸºç¡€æ¶æ„çš„æ­å»ºã€‚é¡¹ç›®é‡‡ç”¨æ¨¡å—åŒ–è®¾è®¡ï¼Œåˆ†ä¸ºä¸‰ä¸ªä¸»è¦åŒ…ï¼š

```
src/my-react/
â”œâ”€â”€ react/              # Reactæ ¸å¿ƒåŒ… - æä¾›createElementã€Componentç­‰API
â”œâ”€â”€ react-dom/          # ReactDOMåŒ… - æä¾›æ¸²æŸ“ç›¸å…³API
â””â”€â”€ react-reconciler/   # åè°ƒå™¨åŒ… - å®ç°Fiberæ¶æ„å’Œè°ƒåº¦é€»è¾‘
```

## ğŸ—ï¸ æ¶æ„è®¾è®¡æ€æƒ³

### 1. åˆ†å±‚æ¶æ„
- **Reactå±‚**: æä¾›å¼€å‘è€…APIï¼Œå¦‚createElementã€Component
- **ReactDOMå±‚**: å¤„ç†DOMç›¸å…³æ“ä½œï¼Œå¦‚createRootã€render
- **Reconcilerå±‚**: æ ¸å¿ƒè°ƒåº¦å’Œåè°ƒé€»è¾‘ï¼Œå®ç°Fiberæ¶æ„

### 2. Fiberæ¶æ„æ ¸å¿ƒæ¦‚å¿µ
- **FiberèŠ‚ç‚¹**: Reactå…ƒç´ çš„å†…éƒ¨è¡¨ç¤ºï¼ŒåŒ…å«å®Œæ•´çš„æ¸²æŸ“ä¿¡æ¯
- **åŒç¼“å†²æŠ€æœ¯**: currentæ ‘å’ŒworkInProgressæ ‘äº¤æ›¿å·¥ä½œ
- **å¯ä¸­æ–­æ¸²æŸ“**: æ”¯æŒæ—¶é—´åˆ‡ç‰‡å’Œä¼˜å…ˆçº§è°ƒåº¦

## ğŸ“ è¯¦ç»†ä»£ç åˆ†æ

### Reactæ ¸å¿ƒåŒ… (`/react/`)

#### 1. ReactTypes.ts - ç±»å‹å®šä¹‰ç³»ç»Ÿ
```typescript
// æ ¸å¿ƒç±»å‹å®šä¹‰
ReactElement    // Reactå…ƒç´ çš„ç±»å‹å®šä¹‰
ReactNode      // å¯æ¸²æŸ“å†…å®¹çš„è”åˆç±»å‹
ReactText      // æ–‡æœ¬å†…å®¹ç±»å‹
Key           // ç”¨äºdiffç®—æ³•çš„å”¯ä¸€æ ‡è¯†
Ref           // DOMå¼•ç”¨æˆ–ç»„ä»¶å®ä¾‹å¼•ç”¨
```

**å…³é”®ç†è§£ç‚¹**:
- `ReactElement`æ˜¯Reactåº”ç”¨çš„åŸºæœ¬æ„å»ºå—
- `ReactNode`å®šä¹‰äº†æ‰€æœ‰å¯ä»¥è¢«Reactæ¸²æŸ“çš„å†…å®¹ç±»å‹
- `Key`å’Œ`Ref`æ˜¯Reactä¸­çš„ç‰¹æ®Šå±æ€§ï¼Œä¸ä¼šä¼ é€’ç»™ç»„ä»¶

#### 2. ReactElement.ts - å…ƒç´ åˆ›å»ºæ ¸å¿ƒ
```typescript
// ä¸»è¦åŠŸèƒ½
createElement()     // JSXè½¬æ¢çš„ç›®æ ‡å‡½æ•°
isValidElement()   // éªŒè¯Reactå…ƒç´ çš„æœ‰æ•ˆæ€§
cloneElement()     // å…‹éš†Reactå…ƒç´ 
```

**å·¥ä½œæµç¨‹**:
1. JSXè¯­æ³• â†’ Babelè½¬æ¢ â†’ createElementè°ƒç”¨
2. æå–keyã€refç­‰ç‰¹æ®Šå±æ€§
3. å¤„ç†childrenå’ŒdefaultProps
4. è¿”å›æ ‡å‡†åŒ–çš„ReactElementå¯¹è±¡

**æ ¸å¿ƒæ•°æ®ç»“æ„**:
```typescript
ReactElement = {
  $$typeof: Symbol.for('react.element'),  // ç±»å‹æ ‡è¯†
  type: 'div' | Component,                // å…ƒç´ ç±»å‹
  key: string | null,                     // diffä¼˜åŒ–æ ‡è¯†
  ref: Ref | null,                        // DOMå¼•ç”¨
  props: { children, ...otherProps }      // å±æ€§å¯¹è±¡
}
```

#### 3. ReactBaseClasses.ts - ç»„ä»¶åŸºç±»
```typescript
// ä¸»è¦ç±»
Component      // åŸºç¡€ç»„ä»¶ç±»
PureComponent  // ä¼˜åŒ–ç‰ˆç»„ä»¶ç±»ï¼ˆè‡ªåŠ¨æµ…æ¯”è¾ƒï¼‰
```

**Componentç±»æ ¸å¿ƒåŠŸèƒ½**:
- `setState()`: çŠ¶æ€æ›´æ–°æœºåˆ¶
- `forceUpdate()`: å¼ºåˆ¶é‡æ–°æ¸²æŸ“
- `render()`: æ¸²æŸ“æ–¹æ³•ï¼ˆæŠ½è±¡æ–¹æ³•ï¼‰

**PureComponentä¼˜åŒ–åŸç†**:
- è‡ªåŠ¨å®ç°`shouldComponentUpdate`
- ä½¿ç”¨æµ…æ¯”è¾ƒç®—æ³•æ¯”è¾ƒpropså’Œstate
- é¿å…ä¸å¿…è¦çš„é‡æ–°æ¸²æŸ“

### ReactDOMåŒ… (`/react-dom/`)

#### 1. ReactDOMRoot.ts - React 18æ–°æ ¹API
```typescript
// æ ¸å¿ƒAPI
createRoot()   // åˆ›å»ºReact 18æ ¹å®¹å™¨
Root.render()  // æ¸²æŸ“Reactå…ƒç´ 
Root.unmount() // å¸è½½åº”ç”¨
```

**React 18æ–°ç‰¹æ€§æ”¯æŒ**:
- å¹¶å‘æ¸²æŸ“èƒ½åŠ›
- è‡ªåŠ¨æ‰¹å¤„ç†
- Suspenseè¾¹ç•Œæ”¯æŒ
- æ›´å¥½çš„å¼€å‘ä½“éªŒ

#### 2. ReactDOMLegacy.ts - å…¼å®¹æ€§API
```typescript
// å…¼å®¹API
render()                    // React 17é£æ ¼çš„æ¸²æŸ“API
unmountComponentAtNode()    // å¸è½½ç»„ä»¶
```

### ReconcileråŒ… (`/react-reconciler/`)

#### 1. ReactFiber.ts - FiberèŠ‚ç‚¹æ ¸å¿ƒ
```typescript
// æ ¸å¿ƒæ•°æ®ç»“æ„
interface Fiber {
  // èŠ‚ç‚¹æ ‡è¯†
  tag: WorkTag              // èŠ‚ç‚¹ç±»å‹
  key: Key                  // diffæ ‡è¯†
  type: any                 // å…ƒç´ ç±»å‹
  
  // æ ‘å½¢ç»“æ„
  return: Fiber             // çˆ¶èŠ‚ç‚¹
  child: Fiber              // ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹
  sibling: Fiber            // ä¸‹ä¸€ä¸ªå…„å¼ŸèŠ‚ç‚¹
  
  // çŠ¶æ€ä¿¡æ¯
  pendingProps: any         // æ–°çš„props
  memoizedProps: any        // æ—§çš„props
  memoizedState: any        // æ—§çš„state
  updateQueue: any          // æ›´æ–°é˜Ÿåˆ—
  
  // å‰¯ä½œç”¨æ ‡è®°
  flags: Flags              // å½“å‰èŠ‚ç‚¹çš„å‰¯ä½œç”¨
  subtreeFlags: Flags       // å­æ ‘çš„å‰¯ä½œç”¨
  
  // åŒç¼“å†²
  alternate: Fiber          // å¯¹åº”çš„å¦ä¸€æ£µæ ‘çš„èŠ‚ç‚¹
}
```

**WorkTagç±»å‹**:
- `FunctionComponent`: å‡½æ•°ç»„ä»¶
- `ClassComponent`: ç±»ç»„ä»¶
- `HostRoot`: æ ¹èŠ‚ç‚¹
- `HostComponent`: DOMå…ƒç´ 
- `HostText`: æ–‡æœ¬èŠ‚ç‚¹

**Flagså‰¯ä½œç”¨æ ‡è®°**:
- `Placement`: éœ€è¦æ’å…¥DOM
- `Update`: éœ€è¦æ›´æ–°å±æ€§
- `Deletion`: éœ€è¦åˆ é™¤

#### 2. ReactFiberRoot.ts - æ ¹èŠ‚ç‚¹ç®¡ç†
```typescript
interface FiberRoot {
  containerInfo: Element        // DOMå®¹å™¨
  current: Fiber               // å½“å‰Fiberæ ‘æ ¹
  finishedWork: Fiber          // å®Œæˆçš„å·¥ä½œæ ‘
  // è°ƒåº¦ç›¸å…³å­—æ®µ...
}
```

#### 3. ReactUpdateQueue.ts - æ›´æ–°é˜Ÿåˆ—
```typescript
// æ›´æ–°å¯¹è±¡
interface Update {
  payload: any              // æ›´æ–°å†…å®¹
  callback: Function        // å›è°ƒå‡½æ•°
  next: Update             // ä¸‹ä¸€ä¸ªæ›´æ–°ï¼ˆç¯å½¢é“¾è¡¨ï¼‰
}

// æ›´æ–°é˜Ÿåˆ—
interface UpdateQueue {
  baseState: any           // åŸºç¡€çŠ¶æ€
  shared: {
    pending: Update        // å¾…å¤„ç†æ›´æ–°
  }
}
```

**æ›´æ–°æµç¨‹**:
1. åˆ›å»ºUpdateå¯¹è±¡
2. åŠ å…¥ç¯å½¢é“¾è¡¨
3. è°ƒåº¦æ›´æ–°
4. å¤„ç†æ›´æ–°é˜Ÿåˆ—

#### 4. ReactFiberReconciler.ts - åè°ƒå™¨å…¥å£
```typescript
// ä¸»è¦åŠŸèƒ½
createContainer()    // åˆ›å»ºFiberæ ¹å®¹å™¨
updateContainer()    // æ›´æ–°å®¹å™¨å†…å®¹
```

## ğŸ”„ æ•°æ®æµå‘åˆ†æ

### 1. åº”ç”¨å¯åŠ¨æµç¨‹
```
createRoot(container) 
  â†’ createContainer() 
  â†’ createFiberRoot() 
  â†’ è¿”å›Rootå¯¹è±¡
```

### 2. æ¸²æŸ“æµç¨‹
```
root.render(element)
  â†’ updateContainer()
  â†’ åˆ›å»ºUpdateå¯¹è±¡
  â†’ enqueueUpdate()
  â†’ scheduleUpdateOnFiber()
  â†’ å¼€å§‹å·¥ä½œå¾ªç¯
```

### 3. Fiberæ ‘æ„å»º
```
currentæ ‘ â†â†’ workInProgressæ ‘
     â†“
  åŒç¼“å†²åˆ‡æ¢
     â†“
  æäº¤åˆ°DOM
```

## ğŸ¯ æ ¸å¿ƒè®¾è®¡æ¨¡å¼

### 1. å·¥å‚æ¨¡å¼
- `createElement`: åˆ›å»ºReactElement
- `createFiber`: åˆ›å»ºFiberèŠ‚ç‚¹
- `createUpdate`: åˆ›å»ºæ›´æ–°å¯¹è±¡

### 2. é“¾è¡¨ç»“æ„
- Fiberæ ‘: ä½¿ç”¨child/sibling/returnæ„å»ºæ ‘å½¢ç»“æ„
- æ›´æ–°é˜Ÿåˆ—: ä½¿ç”¨ç¯å½¢é“¾è¡¨ç®¡ç†æ›´æ–°

### 3. åŒç¼“å†²æ¨¡å¼
- currentæ ‘: å½“å‰æ˜¾ç¤ºçš„UI
- workInProgressæ ‘: æ­£åœ¨æ„å»ºçš„æ–°UI
- å®Œæˆåäº¤æ¢ä¸¤æ£µæ ‘

### 4. ä½è¿ç®—ä¼˜åŒ–
- Flags: ä½¿ç”¨ä½è¿ç®—æ ‡è®°å‰¯ä½œç”¨
- é«˜æ•ˆçš„æ ‡è®°åˆå¹¶å’Œæ£€æŸ¥

## ğŸš€ ä¸‹ä¸€æ­¥å®ç°è®¡åˆ’

### å·²å®Œæˆ âœ…
- [x] åŸºç¡€ç±»å‹å®šä¹‰
- [x] ReactElementåˆ›å»º
- [x] ç»„ä»¶åŸºç±»
- [x] Fiberæ•°æ®ç»“æ„
- [x] æ›´æ–°é˜Ÿåˆ—
- [x] æ ¹å®¹å™¨åˆ›å»º

### å¾…å®ç° ğŸ”„
- [ ] å·¥ä½œå¾ªç¯ (ReactFiberWorkLoop)
- [ ] åè°ƒç®—æ³• (beginWork/completeWork)
- [ ] æäº¤é˜¶æ®µ (commitWork)
- [ ] Hooksç³»ç»Ÿ
- [ ] äº‹ä»¶ç³»ç»Ÿ
- [ ] è°ƒåº¦å™¨

## ğŸ’¡ å­¦ä¹ è¦ç‚¹

### 1. ç†è§£Fiberæ¶æ„çš„ä¼˜åŠ¿
- **å¯ä¸­æ–­**: é•¿ä»»åŠ¡å¯ä»¥è¢«åˆ†å‰²
- **ä¼˜å…ˆçº§**: ä¸åŒæ›´æ–°æœ‰ä¸åŒä¼˜å…ˆçº§
- **å¹¶å‘**: æ”¯æŒå¹¶å‘ç‰¹æ€§

### 2. æŒæ¡Reactçš„æ ¸å¿ƒæ¦‚å¿µ
- **ReactElement**: æè¿°UIçš„æ•°æ®ç»“æ„
- **Fiber**: å†…éƒ¨å·¥ä½œå•å…ƒ
- **æ›´æ–°é˜Ÿåˆ—**: çŠ¶æ€å˜æ›´çš„ç®¡ç†
- **åŒç¼“å†²**: å¹³æ»‘çš„UIæ›´æ–°

### 3. æ·±å…¥ç†è§£æ¸²æŸ“æµç¨‹
- **è°ƒåº¦é˜¶æ®µ**: å†³å®šä½•æ—¶æ›´æ–°
- **åè°ƒé˜¶æ®µ**: è®¡ç®—å˜æ›´ï¼ˆå¯ä¸­æ–­ï¼‰
- **æäº¤é˜¶æ®µ**: åº”ç”¨å˜æ›´åˆ°DOMï¼ˆåŒæ­¥ï¼‰

è¿™ä¸ªæ¶æ„ä¸ºæˆ‘ä»¬åç»­å®ç°Reactçš„é«˜çº§ç‰¹æ€§ï¼ˆå¦‚Hooksã€Suspenseã€å¹¶å‘æ¸²æŸ“ç­‰ï¼‰å¥ å®šäº†åšå®çš„åŸºç¡€ã€‚