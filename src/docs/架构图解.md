# React 18 源码架构图解

## 🏗️ 整体架构图

```mermaid
graph TB
    subgraph "用户代码层"
        JSX[JSX语法]
        APP[React应用]
    end
    
    subgraph "React核心包"
        CE[createElement]
        COMP[Component/PureComponent]
        TYPES[TypeScript类型]
    end
    
    subgraph "ReactDOM包"
        ROOT[createRoot]
        RENDER[render方法]
        LEGACY[兼容API]
    end
    
    subgraph "Reconciler协调器"
        FIBER[Fiber节点]
        QUEUE[更新队列]
        RECONCILER[协调器入口]
        WORKLOOP[工作循环 ❌]
        BEGIN[beginWork ❌]
        COMPLETE[completeWork ❌]
        COMMIT[commitWork ❌]
    end
    
    subgraph "DOM层"
        DOM[真实DOM]
        EVENT[事件系统 ❌]
    end
    
    JSX --> CE
    APP --> ROOT
    ROOT --> RECONCILER
    RECONCILER --> FIBER
    RECONCILER --> QUEUE
    RECONCILER --> WORKLOOP
    WORKLOOP --> BEGIN
    BEGIN --> COMPLETE
    COMPLETE --> COMMIT
    COMMIT --> DOM
    
    style WORKLOOP fill:#ffcccc
    style BEGIN fill:#ffcccc
    style COMPLETE fill:#ffcccc
    style COMMIT fill:#ffcccc
    style EVENT fill:#ffcccc
```

## 🔄 数据流向图

```mermaid
sequenceDiagram
    participant User as 用户代码
    participant React as React包
    participant ReactDOM as ReactDOM包
    participant Reconciler as 协调器
    participant DOM as DOM
    
    User->>React: JSX → createElement()
    React-->>User: ReactElement
    
    User->>ReactDOM: createRoot(container)
    ReactDOM->>Reconciler: createContainer()
    Reconciler-->>ReactDOM: FiberRoot
    ReactDOM-->>User: Root对象
    
    User->>ReactDOM: root.render(element)
    ReactDOM->>Reconciler: updateContainer()
    Reconciler->>Reconciler: 创建Update对象
    Reconciler->>Reconciler: enqueueUpdate()
    
    Note over Reconciler: ❌ 缺失部分开始
    Reconciler->>Reconciler: scheduleUpdateOnFiber()
    Reconciler->>Reconciler: workLoop()
    Reconciler->>Reconciler: beginWork()
    Reconciler->>Reconciler: completeWork()
    Reconciler->>DOM: commitWork()
    Note over Reconciler: ❌ 缺失部分结束
```

## 🌳 Fiber树结构图

```mermaid
graph TD
    subgraph "Current树（当前显示）"
        CR[HostRoot]
        CA[App组件]
        CD[div元素]
        CT[文本节点]
        
        CR --> CA
        CA --> CD
        CD --> CT
    end
    
    subgraph "WorkInProgress树（正在构建）"
        WR[HostRoot]
        WA[App组件]
        WD[div元素]
        WT[文本节点]
        
        WR --> WA
        WA --> WD
        WD --> WT
    end
    
    CR -.->|alternate| WR
    CA -.->|alternate| WA
    CD -.->|alternate| WD
    CT -.->|alternate| WT
    
    style CR fill:#e1f5fe
    style CA fill:#e1f5fe
    style CD fill:#e1f5fe
    style CT fill:#e1f5fe
    
    style WR fill:#fff3e0
    style WA fill:#fff3e0
    style WD fill:#fff3e0
    style WT fill:#fff3e0
```

## 📦 模块依赖关系图

```mermaid
graph LR
    subgraph "React包"
        RT[ReactTypes.ts]
        RE[ReactElement.ts]
        RB[ReactBaseClasses.ts]
        RI[index.ts]
    end
    
    subgraph "ReactDOM包"
        RDR[ReactDOMRoot.ts]
        RDL[ReactDOMLegacy.ts]
        RDI[index.ts]
    end
    
    subgraph "Reconciler包"
        RF[ReactFiber.ts]
        RFR[ReactFiberRoot.ts]
        RUQ[ReactUpdateQueue.ts]
        RFRC[ReactFiberReconciler.ts]
        RWL[ReactFiberWorkLoop.ts ❌]
        RBW[ReactFiberBeginWork.ts ❌]
        RCW[ReactFiberCompleteWork.ts ❌]
        RCMT[ReactFiberCommitWork.ts ❌]
    end
    
    RT --> RE
    RT --> RB
    RE --> RI
    RB --> RI
    
    RT --> RDR
    RFRC --> RDR
    RDR --> RDI
    RDL --> RDI
    
    RT --> RF
    RF --> RFR
    RF --> RUQ
    RFR --> RFRC
    RUQ --> RFRC
    RWL --> RFRC
    
    RWL --> RBW
    RBW --> RCW
    RCW --> RCMT
    
    style RWL fill:#ffcccc
    style RBW fill:#ffcccc
    style RCW fill:#ffcccc
    style RCMT fill:#ffcccc
```

## 🔧 Fiber节点结构图

```mermaid
graph TB
    subgraph "Fiber节点"
        subgraph "标识信息"
            TAG[tag: WorkTag]
            KEY[key: string]
            TYPE[type: any]
            ELEM[elementType: any]
        end
        
        subgraph "树形结构"
            RETURN[return: Fiber]
            CHILD[child: Fiber]
            SIBLING[sibling: Fiber]
        end
        
        subgraph "状态信息"
            PPROPS[pendingProps: any]
            MPROPS[memoizedProps: any]
            MSTATE[memoizedState: any]
            QUEUE[updateQueue: UpdateQueue]
        end
        
        subgraph "副作用"
            FLAGS[flags: Flags]
            SUBFLAGS[subtreeFlags: Flags]
            DELETIONS[deletions: Fiber[]]
        end
        
        subgraph "双缓冲"
            ALT[alternate: Fiber]
            STATENODE[stateNode: any]
        end
    end
```

## 🎯 更新队列结构图

```mermaid
graph LR
    subgraph "UpdateQueue"
        BASE[baseState]
        SHARED[shared]
    end
    
    subgraph "环形链表"
        U1[Update1]
        U2[Update2]
        U3[Update3]
        U4[Update4]
        
        U1 --> U2
        U2 --> U3
        U3 --> U4
        U4 --> U1
    end
    
    SHARED --> U1
    
    subgraph "Update结构"
        PAYLOAD[payload: any]
        CALLBACK[callback: Function]
        NEXT[next: Update]
    end
```

## 🚀 渲染流程图

```mermaid
graph TD
    START[开始渲染] --> CREATE[创建Update]
    CREATE --> ENQUEUE[加入更新队列]
    ENQUEUE --> SCHEDULE[调度更新 ❌]
    
    SCHEDULE --> WORKLOOP[工作循环 ❌]
    WORKLOOP --> BEGINWORK[beginWork ❌]
    BEGINWORK --> RECONCILE[协调子节点 ❌]
    RECONCILE --> COMPLETEWORK[completeWork ❌]
    
    COMPLETEWORK --> COMMIT[提交阶段 ❌]
    COMMIT --> BEFORE[before mutation ❌]
    BEFORE --> MUTATION[mutation ❌]
    MUTATION --> LAYOUT[layout ❌]
    
    LAYOUT --> END[渲染完成]
    
    style SCHEDULE fill:#ffcccc
    style WORKLOOP fill:#ffcccc
    style BEGINWORK fill:#ffcccc
    style RECONCILE fill:#ffcccc
    style COMPLETEWORK fill:#ffcccc
    style COMMIT fill:#ffcccc
    style BEFORE fill:#ffcccc
    style MUTATION fill:#ffcccc
    style LAYOUT fill:#ffcccc
```

## 📊 实现进度图

```mermaid
pie title 实现进度统计
    "已完成" : 60
    "待实现" : 40
```

```mermaid
gantt
    title React 18 实现进度
    dateFormat  YYYY-MM-DD
    section 基础架构
    类型定义     :done, types, 2024-01-01, 2024-01-02
    ReactElement :done, element, 2024-01-02, 2024-01-03
    组件基类     :done, component, 2024-01-03, 2024-01-04
    Fiber结构    :done, fiber, 2024-01-04, 2024-01-05
    
    section 渲染流程
    工作循环     :crit, workloop, 2024-01-05, 2024-01-07
    协调算法     :crit, reconcile, 2024-01-07, 2024-01-09
    提交阶段     :crit, commit, 2024-01-09, 2024-01-11
    
    section 高级特性
    Hooks系统    :hooks, 2024-01-11, 2024-01-13
    事件系统     :events, 2024-01-13, 2024-01-15
    调度器       :scheduler, 2024-01-15, 2024-01-17
```

## 💡 关键理解点

### 1. Fiber架构的核心优势
- **可中断性**: 长任务可以被分割成小任务
- **优先级**: 不同更新有不同的优先级
- **双缓冲**: 平滑的UI更新体验

### 2. 数据结构设计精髓
- **链表结构**: 高效的插入和删除操作
- **位运算**: 高效的标记和检查
- **环形链表**: 更新队列的高效管理

### 3. 渲染流程的两个阶段
- **协调阶段**: 可中断，计算变更
- **提交阶段**: 同步执行，应用变更

这些图表帮助您从不同角度理解React的架构设计，为后续的代码实现提供清晰的指导。